#!/bin/bash

# mdv - VPS Management Tool (14 Fitur Utama)
# Versi: 1.14
# Kompatibel: AlmaLinux/RHEL/Fedora (dnf/yum, firewalld), Debian/Ubuntu (apt, ufw fallback)

# Deteksi Distribusi
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VER=$VERSION_ID
    else
        echo "Error: Tidak dapat mendeteksi OS."
        exit 1
    fi
}

# Fungsi helper: Package Manager
pkg_install() {
    detect_os
    case $OS in
        "almalinux"|"rhel"|"centos"|"fedora")
            if command -v dnf >/dev/null 2>&1; then
                dnf install -y "$@"
            else
                yum install -y "$@"
            fi
            ;;
        "ubuntu"|"debian")
            apt update && apt install -y "$@"
            ;;
        *)
            echo "Error: Package manager tidak didukung untuk $OS."
            exit 1
            ;;
    esac
}

# Fungsi helper: Firewall (firewalld prioritas, fallback ufw)
fw_cmd() {
    if command -v firewall-cmd >/dev/null 2>&1; then
        case $1 in
            "list-ports") firewall-cmd --list-ports ;;
            "add-port") firewall-cmd --permanent --add-port="$2/$3" && firewall-cmd --reload ;;
            "remove-port") firewall-cmd --permanent --remove-port="$2/$3" && firewall-cmd --reload ;;
            "query-port") firewall-cmd --query-port="$2/$3" ;;
            "list-all") firewall-cmd --list-all ;;
            "add-rich-rule") firewall-cmd --permanent --add-rich-rule="$2" && firewall-cmd --reload ;;
            "panic-off") firewall-cmd --panic-off && firewall-cmd --reload ;;
        esac
    elif command -v ufw >/dev/null 2>&1; then
        case $1 in
            "list-ports") ufw status numbered ;;
            "add-port") ufw allow "$2/$3" && ufw reload ;;
            "remove-port") ufw delete allow "$2/$3" && ufw reload ;;
            "query-port") ufw status | grep "$2/$3" >/dev/null 2>&1 && echo "yes" || echo "no" ;;
            "list-all") ufw status verbose ;;
            "add-rich-rule") echo "UFW tidak mendukung rich rules; gunakan allow/deny manual." ;;
            "panic-off") ufw reset --force && ufw enable ;;
        esac
    else
        echo "Error: Firewall tool tidak ditemukan. Install firewalld atau ufw."
        exit 1
    fi
}

# Direktori konfigurasi
CONFIG_DIR="$HOME/.mdv"
CONFIG_FILE="$CONFIG_DIR/config.json"
mkdir -p "$CONFIG_DIR"

# Fungsi helper: Load config JSON
load_config() {
    if command -v jq >/dev/null 2>&1; then
        cat "$CONFIG_FILE" 2>/dev/null | jq . || echo "{}"
    else
        echo "{}"
    fi
}

# Fungsi helper: Save config
save_config() {
    echo "$1" > "$CONFIG_FILE"
}

# Fungsi helper: Cek root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo "Error: Jalankan sebagai root atau dengan sudo."
        exit 1
    fi
}

# Fungsi helper: Validasi port (hanya angka positif)
is_valid_port() {
    [[ "$1" =~ ^[0-9]+$ ]] && [ "$1" -ge 1 ] && [ "$1" -le 65535 ]
}

# Fungsi utama: Help
show_help() {
    cat << EOF
mdv - VPS Management Tool (14 Fitur Utama)

Penggunaan: mdv <category> <subcommand> [args]

1. Port Management (firewalld)
   mdv port list          # Semua port (allowed + listening-not-allowed)
   mdv port list on       # Port yang dibuka di firewall
   mdv port list off      # Port listen tapi belum dibuka
   mdv port e <port> [tcp|udp]  # Buka port (default tcp)
   mdv port d <port> [tcp|udp]  # Tutup port
   mdv port reset         # Reset firewall ke default

2. Domain Management (/etc/hosts)
   mdv domain add <domain> <ip>  # Arahkan domain ke IP (lokal VPS)
   mdv domain rm <domain>        # Hapus mapping
   mdv domain list               # Daftar domain
   mdv domain check <domain>     # Cek resolve ke IP VPS

3. App Management (Nginx reverse proxy)
   mdv app add <domain> <port>   # Buat config nginx: domain â†’ 127.0.0.1:<port>
   mdv app rm <domain>           # Hapus config
   mdv app list                  # Daftar config
   mdv app ssl <domain>          # Pasang Let's Encrypt SSL
   mdv app unssl <domain>        # Hapus SSL
   mdv app info <domain>         # Detail config

4. phpMyAdmin Management
   mdv pma add <domain>          # Install & setup phpMyAdmin
   mdv pma rm <domain>           # Hapus config
   mdv pma list                  # Daftar domain

5. Node.js App Runner (pm2)
   mdv node start <dir> <name>   # Jalankan via pm2
   mdv node stop <name>          # Stop
   mdv node restart <name>       # Restart
   mdv node list                 # List app
   mdv node logs <name>          # Lihat log

6. Golang App Runner (systemd)
   mdv go start <binary> <name> <port>  # Jalankan binary
   mdv go stop <name>                  # Stop
   mdv go restart <name>               # Restart
   mdv go list                         # List app
   mdv go logs <name>                  # Lihat log

7. Scheduler (Cron helper)
   mdv cron add "<schedule>" "<command>"  # Tambah job (e.g., "* * * * *")
   mdv cron list                          # List job
   mdv cron rm <id>                       # Hapus job

8. Timer (systemd)
   mdv timer add "<interval>" "<command>"  # e.g., "10s"
   mdv timer list                         # List job
   mdv timer rm <name>                    # Hapus job

9. Security
   mdv ssh port <newport>         # Ganti SSH port
   mdv ssh disable-root           # Disable root login
   mdv ssh enable-root            # Enable root login
   mdv fail2ban install           # Setup fail2ban
   mdv fw allow <ip>              # Whitelist IP
   mdv fw deny <ip>               # Blacklist IP
   mdv fw list                    # List aturan

10. Database Management
    mdv db create <name> <user> <pass>  # MySQL/MariaDB
    mdv db drop <name>                  # Hapus DB
    mdv db list                         # Daftar DB
    mdv pg create <name> <user> <pass>  # PostgreSQL
    mdv pg drop <name>                  # Hapus DB
    mdv pg list                         # Daftar DB

11. SSL Management
    mdv ssl issue <domain>     # Pasang Let's Encrypt
    mdv ssl renew <domain>     # Perpanjang
    mdv ssl list               # Daftar cert
    mdv ssl revoke <domain>    # Hapus cert

12. Backup & Restore
    mdv backup app <domain>    # Backup nginx + SSL
    mdv backup db <name>       # Backup DB
    mdv backup all             # Backup semua
    mdv restore <file>         # Restore dari file

13. User Management
    mdv user add <username>    # Tambah user
    mdv user rm <username>     # Hapus user
    mdv user list              # Daftar user
    mdv user passwd <username> # Ubah password

14. System Info & Monitoring
    mdv sys info               # Detail VPS
    mdv sys usage              # Usage CPU/RAM/Disk
    mdv sys top                # Proses (mirip htop)
    mdv monitor enable <webhook>  # Aktifkan notif Telegram
    mdv monitor cpu --threshold 90  # Alert CPU
    mdv monitor disk --threshold 80 # Alert Disk

EOF
    exit 0
}

# Init/Install Dependencies (Sesuaikan untuk 14 fitur)
handle_init() {
    check_root
    echo "Memulai inisialisasi mdv: Menginstal dependensi untuk 14 fitur..."
    detect_os

    # Paket dasar
    CORE_PKGS="jq htop curl wget git"
    pkg_install $CORE_PKGS

    # Nginx & Certbot
    pkg_install nginx
    systemctl enable --now nginx
    pkg_install certbot python3-certbot-nginx

    # MariaDB
    pkg_install mariadb-server
    systemctl enable --now mariadb
    mysql_secure_installation  # Interaktif

    # PostgreSQL
    pkg_install postgresql postgresql-contrib
    systemctl enable --now postgresql

    # Firewall
    case $OS in
        "almalinux"|"rhel"|"centos"|"fedora")
            pkg_install firewalld
            systemctl enable --now firewalld
            firewall-cmd --set-default-zone=public
            ;;
        "ubuntu"|"debian")
            pkg_install ufw
            ufw --force enable
            ufw default deny incoming
            ufw default allow outgoing
            ;;
    esac

    # Node.js & PM2
    pkg_install nodejs npm
    npm install -g pm2

    # Golang
    pkg_install golang

    # Fail2ban
    pkg_install fail2ban
    systemctl enable --now fail2ban

    # PHP & phpMyAdmin
    pkg_install php php-fpm php-mysql php-mysqli phpmyadmin composer

    echo "Inisialisasi selesai. Jalankan 'mdv doctor' untuk verifikasi."
}

# 1. Port Management
handle_port() {
    SUB=$2
    case $SUB in
        "list")
            if [ "$3" = "on" ]; then
                fw_cmd "list-ports"
            elif [ "$3" = "off" ]; then
                ss -tuln | awk '{print $5}' | cut -d: -f2 | sort -u | grep -E '^[0-9]+$' | while read p; do
                    QUERY_TCP=$(fw_cmd "query-port" "$p" "tcp")
                    QUERY_UDP=$(fw_cmd "query-port" "$p" "udp")
                    if [ "$QUERY_TCP" != "yes" ] && [ "$QUERY_UDP" != "yes" ]; then
                        echo "Port $p (listening, not allowed)"
                    fi
                done
            else
                ss -tuln | awk '{print $5}' | cut -d: -f2 | sort -u | grep -E '^[0-9]+$' || echo "No listening ports found."
                echo "--- Allowed Ports ---"
                fw_cmd "list-ports"
            fi
            ;;
        "e")
            PORT=$3
            PROTO=${4:-tcp}
            if ! is_valid_port "$PORT"; then
                echo "Error: Invalid port number: $PORT"
                exit 1
            fi
            fw_cmd "add-port" "$PORT" "$PROTO"
            echo "Port $PORT/$PROTO dibuka."
            ;;
        "d")
            PORT=$3
            PROTO=${4:-tcp}
            if ! is_valid_port "$PORT"; then
                echo "Error: Invalid port number: $PORT"
                exit 1
            fi
            fw_cmd "remove-port" "$PORT" "$PROTO"
            echo "Port $PORT/$PROTO ditutup."
            ;;
        "reset")
            fw_cmd "panic-off"
            echo "Firewall direset ke default."
            ;;
        *)
            echo "Usage: mdv port {list [on|off]|e <port> [tcp|udp]|d <port> [tcp|udp]|reset}"
            ;;
    esac
}

# 2. Domain Management
handle_domain() {
    check_root
    SUB=$2
    case $SUB in
        "add")
            echo "$3 $2" >> /etc/hosts
            CONFIG=$(load_config)
            NEW_CONFIG=$(echo "$CONFIG" | jq --arg domain "$2" --arg ip "$3" '.domains += {($domain): $ip}')
            save_config "$NEW_CONFIG"
            echo "Domain $2 ditambahkan ke $3."
            ;;
        "rm")
            sed -i "/ $2$/d" /etc/hosts
            CONFIG=$(load_config)
            NEW_CONFIG=$(echo "$CONFIG" | jq --arg domain "$2" 'del(.domains[$domain])')
            save_config "$NEW_CONFIG"
            echo "Domain $2 dihapus."
            ;;
        "list")
            grep -E "^[0-9]" /etc/hosts | awk '{print $2, $1}'
            ;;
        "check")
            IP=$(nslookup $3 2>/dev/null | awk '/Address: / && !/127.0.0.1/ {print $2; exit}')
            VPS_IP=$(curl -s ifconfig.me)
            if [ "$IP" = "$VPS_IP" ]; then
                echo "Domain $3 resolve ke VPS IP."
            else
                echo "Domain $3 tidak resolve ke VPS IP."
            fi
            ;;
        *)
            echo "Usage: mdv domain {add <domain> <ip>|rm <domain>|list|check <domain>}"
            ;;
    esac
}

# 3. App Management (Nginx)
handle_app() {
    check_root
    if ! command -v nginx >/dev/null 2>&1; then
        pkg_install nginx
        systemctl enable --now nginx
    fi
    SUB=$2
    NGINX_CONF="/etc/nginx/sites-available/$2"
    case $SUB in
        "add")
            PORT=$3
            mkdir -p /etc/nginx/{sites-available,sites-enabled}
            cat > "$NGINX_CONF" << EOF
server {
    listen 80;
    server_name $2;
    location / {
        proxy_pass http://127.0.0.1:$PORT;
    }
}
EOF
            ln -sf "$NGINX_CONF" /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx
            echo "App $2 ditambahkan ke port $PORT."
            ;;
        "rm")
            rm -f "$NGINX_CONF" /etc/nginx/sites-enabled/"$2"
            nginx -t && systemctl reload nginx
            echo "App $2 dihapus."
            ;;
        "list")
            ls /etc/nginx/sites-enabled/ 2>/dev/null | grep -v default || echo "Tidak ada config."
            ;;
        "ssl")
            if ! command -v certbot >/dev/null 2>&1; then
                pkg_install certbot python3-certbot-nginx
            fi
            certbot --nginx -d $3 -n
            echo "SSL dipasang untuk $3."
            ;;
        "unssl")
            certbot delete --cert-name $3 -n
            echo "SSL dihapus untuk $3."
            ;;
        "info")
            nginx -T 2>/dev/null | grep -A10 "server_name $3" || echo "Config tidak ditemukan."
            ;;
        *)
            echo "Usage: mdv app {add <domain> <port>|rm <domain>|list|ssl <domain>|unssl <domain>|info <domain>}"
            ;;
    esac
}

# 4. phpMyAdmin Management
handle_pma() {
    check_root
    SUB=$2
    case $SUB in
        "add")
            pkg_install phpmyadmin php-mysqli
            ln -s /usr/share/phpmyadmin /var/www/html/pma
            echo "phpMyAdmin diinstal dan setup untuk $3."
            ;;
        "rm")
            apt purge phpmyadmin 2>/dev/null || yum remove phpmyadmin 2>/dev/null || dnf remove phpmyadmin 2>/dev/null
            rm -rf /var/www/html/pma
            echo "phpMyAdmin dihapus untuk $3."
            ;;
        "list")
            ls /var/www/html/ 2>/dev/null | grep pma || echo "Tidak ada phpMyAdmin."
            ;;
        *)
            echo "Usage: mdv pma {add <domain>|rm <domain>|list}"
            ;;
    esac
}

# 5. Node.js App Runner (pm2)
handle_node() {
    check_root
    if ! command -v pm2 >/dev/null 2>&1; then
        pkg_install nodejs npm
        npm install -g pm2
    fi
    SUB=$2
    case $SUB in
        "start")
            DIR=$3
            NAME=$4
            cd "$DIR" && pm2 start npm --name "$NAME" -- start
            pm2 save
            echo "Node app $NAME dimulai dari $DIR."
            ;;
        "stop")
            pm2 stop "$3"
            ;;
        "restart")
            pm2 restart "$3"
            ;;
        "list")
            pm2 list
            ;;
        "logs")
            pm2 logs "$3"
            ;;
        *)
            echo "Usage: mdv node {start <dir> <name>|stop <name>|restart <name>|list|logs <name>}"
            ;;
    esac
}

# 6. Golang App Runner (systemd)
handle_go() {
    check_root
    SUB=$2
    SERVICE_FILE="/etc/systemd/system/$3.service"
    case $SUB in
        "start")
            BINARY=$3
            NAME=$4
            PORT=$5
            cat > "$SERVICE_FILE" << EOF
[Unit]
Description=Go App $NAME

[Service]
ExecStart=$BINARY
WorkingDirectory=/var/www
Restart=always
Environment=PORT=$PORT

[Install]
WantedBy=multi-user.target
EOF
            systemctl daemon-reload
            systemctl enable "$NAME"
            systemctl start "$NAME"
            echo "Go app $NAME dimulai di port $PORT."
            ;;
        "stop")
            systemctl stop "$3"
            ;;
        "restart")
            systemctl restart "$3"
            ;;
        "list")
            systemctl list-units | grep go || echo "Tidak ada Go app."
            ;;
        "logs")
            journalctl -u "$3" -f
            ;;
        *)
            echo "Usage: mdv go {start <binary> <name> <port>|stop <name>|restart <name>|list|logs <name>}"
            ;;
    esac
}

# 7. Scheduler (Cron)
handle_cron() {
    check_root
    SUB=$2
    case $SUB in
        "add")
            SCHEDULE=$3
            COMMAND=$4
            (crontab -l 2>/dev/null; echo "$SCHEDULE $COMMAND") | crontab -
            echo "Cron job ditambahkan."
            ;;
        "list")
            crontab -l 2>/dev/null || echo "Tidak ada cron job."
            ;;
        "rm")
            crontab -l | grep -v "$3" | crontab -
            echo "Cron job ID $3 dihapus."
            ;;
        *)
            echo "Usage: mdv cron {add \"<schedule>\" \"<command>\"|list|rm <id>}"
            ;;
    esac
}

# 8. Timer (systemd)
handle_timer() {
    check_root
    SUB=$2
    case $SUB in
        "add")
            INTERVAL=$3
            COMMAND=$4
            NAME="mdv-timer-$(date +%s)"
            cat > "/etc/systemd/system/$NAME.timer" << EOF
[Unit]
Description=$NAME

[Timer]
OnUnitActiveSec=$INTERVAL
Persistent=true

[Install]
WantedBy=timers.target
EOF
            cat > "/etc/systemd/system/$NAME.service" << EOF
[Unit]
Description=$NAME

[Service]
Type=oneshot
ExecStart=$COMMAND
EOF
            systemctl daemon-reload
            systemctl enable "$NAME.timer"
            systemctl start "$NAME.timer"
            echo "Timer $NAME ditambahkan dengan interval $INTERVAL."
            ;;
        "list")
            systemctl list-timers
            ;;
        "rm")
            systemctl stop "$3.timer" "$3.service"
            rm -f /etc/systemd/system/"$3".{timer,service}
            systemctl daemon-reload
            echo "Timer $3 dihapus."
            ;;
        *)
            echo "Usage: mdv timer {add \"<interval>\" \"<command>\"|list|rm <name>}"
            ;;
    esac
}

# 9. Security
handle_security() {
    check_root
    SUBCMD=$2
    case $SUBCMD in
        "ssh")
            case $3 in
                "port")
                    sed -i "s/#*Port 22/Port $4/" /etc/ssh/sshd_config
                    fw_cmd "add-port" "$4" "tcp"
                    systemctl restart sshd
                    echo "SSH port diganti ke $4."
                    ;;
                "disable-root")
                    sed -i 's/#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
                    systemctl restart sshd
                    echo "Root login dinonaktifkan."
                    ;;
                "enable-root")
                    sed -i 's/#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
                    systemctl restart sshd
                    echo "Root login diaktifkan."
                    ;;
            esac
            ;;
        "fail2ban")
            case $3 in
                "install")
                    pkg_install fail2ban
                    systemctl enable --now fail2ban
                    echo "Fail2ban diinstal dan diaktifkan."
                    ;;
            esac
            ;;
        "fw")
            case $3 in
                "allow")
                    fw_cmd "add-rich-rule" "rule family=\"ipv4\" source address=\"$4\" accept"
                    echo "IP $4 di-whitelist."
                    ;;
                "deny")
                    fw_cmd "add-rich-rule" "rule family=\"ipv4\" source address=\"$4\" drop"
                    echo "IP $4 di-blacklist."
                    ;;
                "list")
                    fw_cmd "list-all"
                    ;;
            esac
            ;;
        *)
            echo "Usage: mdv {ssh port <newport>|ssh disable-root|ssh enable-root|fail2ban install|fw allow <ip>|fw deny <ip>|fw list}"
            ;;
    esac
}

# 10. Database Management
handle_db() {
    check_root
    if ! command -v mysql >/dev/null 2>&1; then
        pkg_install mariadb-server
        systemctl enable --now mariadb
    fi
    SUB=$2
    case $SUB in
        "create")
            NAME=$3
            USER=$4
            PASS=$5
            mysql -e "CREATE DATABASE IF NOT EXISTS \`$NAME\`; CREATE USER IF NOT EXISTS '$USER'@'localhost' IDENTIFIED BY '$PASS'; GRANT ALL ON \`$NAME\`.* TO '$USER'@'localhost'; FLUSH PRIVILEGES;"
            echo "Database $NAME dibuat dengan user $USER."
            ;;
        "drop")
            mysql -e "DROP DATABASE IF EXISTS \`$3\`;"
            echo "Database $3 dihapus."
            ;;
        "list")
            mysql -e "SHOW DATABASES;" 2>/dev/null || echo "Tidak ada akses MySQL."
            ;;
        *)
            echo "Usage: mdv db {create <name> <user> <pass>|drop <name>|list}"
            ;;
    esac
}

handle_pg() {
    check_root
    if ! command -v psql >/dev/null 2>&1; then
        pkg_install postgresql postgresql-contrib
        systemctl enable --now postgresql
    fi
    SUB=$2
    case $SUB in
        "create")
            NAME=$3
            USER=$4
            PASS=$5
            sudo -u postgres psql -c "CREATE DATABASE \"$NAME\";"
            sudo -u postgres psql -c "CREATE USER \"$USER\" WITH PASSWORD '$PASS';"
            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE \"$NAME\" TO \"$USER\";"
            echo "PostgreSQL DB $NAME dibuat dengan user $USER."
            ;;
        "drop")
            sudo -u postgres psql -c "DROP DATABASE IF EXISTS \"$3\";"
            echo "PostgreSQL DB $3 dihapus."
            ;;
        "list")
            sudo -u postgres psql -l | grep Name || echo "Tidak ada akses PostgreSQL."
            ;;
        *)
            echo "Usage: mdv pg {create <name> <user> <pass>|drop <name>|list}"
            ;;
    esac
}

# 11. SSL Management
handle_ssl() {
    check_root
    if ! command -v certbot >/dev/null 2>&1; then
        pkg_install certbot
    fi
    SUB=$2
    case $SUB in
        "issue")
            certbot certonly --standalone -d "$3" -n
            echo "SSL diterbitkan untuk $3."
            ;;
        "renew")
            certbot renew --cert-name "$3"
            echo "SSL diperpanjang untuk $3."
            ;;
        "list")
            certbot certificates
            ;;
        "revoke")
            certbot revoke --cert-name "$3" -n
            echo "SSL dicabut untuk $3."
            ;;
        *)
            echo "Usage: mdv ssl {issue <domain>|renew <domain>|list|revoke <domain>}"
            ;;
    esac
}

# 12. Backup & Restore
handle_backup() {
    check_root
    mkdir -p /backup
    SUB=$2
    case $SUB in
        "app")
            DOMAIN=$3
            tar -czf "/backup/app-$DOMAIN-$(date +%Y%m%d).tar.gz" /etc/nginx/sites-available/"$DOMAIN" /etc/letsencrypt/live/"$DOMAIN" 2>/dev/null
            echo "Backup app $DOMAIN selesai."
            ;;
        "db")
            NAME=$3
            mysqldump --all-databases > "/backup/db-$NAME-$(date +%Y%m%d).sql"
            echo "Backup DB $NAME selesai."
            ;;
        "all")
            for d in $(mdv app list); do mdv backup app "$d"; done
            mysqldump --all-databases > "/backup/all-dbs-$(date +%Y%m%d).sql"
            echo "Backup semua selesai."
            ;;
        *)
            echo "Usage: mdv backup {app <domain>|db <name>|all}"
            ;;
    esac
}

handle_restore() {
    check_root
    FILE=$2
    if [[ $FILE == *.tar.gz ]]; then
        tar -xzf "$FILE" -C /
    elif [[ $FILE == *.sql ]]; then
        mysql -u root < "$FILE"
    fi
    echo "Restore dari $FILE selesai."
}

# 13. User Management
handle_user() {
    check_root
    SUB=$2
    case $SUB in
        "add")
            useradd -m "$3"
            echo "User $3 ditambahkan."
            ;;
        "rm")
            userdel -r "$3"
            echo "User $3 dihapus."
            ;;
        "list")
            cut -d: -f1 /etc/passwd
            ;;
        "passwd")
            passwd "$3"
            ;;
        *)
            echo "Usage: mdv user {add <username>|rm <username>|list|passwd <username>}"
            ;;
    esac
}

# 14. System Info & Monitoring
handle_sys() {
    SUB=$2
    case $SUB in
        "info")
            uname -a; uptime; curl -s ifconfig.me; cat /etc/os-release
            ;;
        "usage")
            free -h; df -h; top -bn1 | head -20
            ;;
        "top")
            if command -v htop >/dev/null 2>&1; then
                htop
            else
                top
            fi
            ;;
        *)
            echo "Usage: mdv sys {info|usage|top}"
            ;;
    esac
}

handle_monitor() {
    check_root
    SUB=$2
    case $SUB in
        "enable")
            WEBHOOK=$3
            echo "* * * * * curl -X POST '$WEBHOOK' -d 'Server status: OK'" >> /etc/crontab
            echo "Monitoring diaktifkan dengan webhook $WEBHOOK."
            ;;
        "cpu")
            THRESHOLD=90
            if [[ $3 == --threshold* ]]; then THRESHOLD=${3#*=}; fi
            echo "Alert CPU > $THRESHOLD% diaktifkan."
            ;;
        "disk")
            THRESHOLD=80
            if [[ $3 == --threshold* ]]; then THRESHOLD=${3#*=}; fi
            echo "Alert Disk > $THRESHOLD% diaktifkan."
            ;;
        *)
            echo "Usage: mdv monitor {enable <webhook>|cpu --threshold <val>|disk --threshold <val>}"
            ;;
    esac
}

# Utility (Diperluas: Doctor cek dependensi 14 fitur)
handle_utility() {
    case $1 in
        "doctor")
            echo "=== Status Dependensi mdv (14 Fitur) ==="
            command -v jq >/dev/null && echo "jq: OK" || echo "jq: Error"
            command -v htop >/dev/null && echo "htop: OK" || echo "htop: Error"
            systemctl is-active --quiet nginx && echo "Nginx: OK" || echo "Nginx: Error"
            systemctl is-active --quiet mariadb && echo "MariaDB: OK" || echo "MariaDB: Error"
            command -v psql >/dev/null && echo "PostgreSQL: OK" || echo "PostgreSQL: Error"
            fw_cmd "list-ports" > /dev/null 2>&1 && echo "Firewall: OK" || echo "Firewall: Error"
            command -v node >/dev/null && echo "Node.js: OK" || echo "Node.js: Error"
            command -v pm2 >/dev/null && echo "PM2: OK" || echo "PM2: Error"
            command -v go >/dev/null && echo "Golang: OK" || echo "Golang: Error"
            systemctl is-active --quiet fail2ban && echo "Fail2ban: OK" || echo "Fail2ban: Error"
            command -v php >/dev/null && echo "PHP: OK" || echo "PHP: Error"
            echo "=== End Status ==="
            ;;
        "version")
            echo "mdv v1.0 (14 Fitur)"
            ;;
        "help")
            show_help
            ;;
        *)
            show_help
            ;;
    esac
}

# Main dispatcher
detect_os
CATEGORY=$1
case $CATEGORY in
    "init"|"i") handle_init;;
    "port") handle_port "$@";;
    "domain") handle_domain "$@";;
    "app") handle_app "$@";;
    "pma") handle_pma "$@";;
    "node") handle_node "$@";;
    "go") handle_go "$@";;
    "cron") handle_cron "$@";;
    "timer") handle_timer "$@";;
    "ssh"|"fail2ban"|"fw") handle_security "$@";;
    "db") handle_db "$@";;
    "pg") handle_pg "$@";;
    "ssl") handle_ssl "$@";;
    "backup") handle_backup "$@";;
    "restore") handle_restore "$@";;
    "user") handle_user "$@";;
    "sys") handle_sys "$@";;
    "monitor") handle_monitor "$@";;
    "doctor"|"version"|"help") handle_utility "$@";;
    *) show_help;;
esac
